<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>íŠ¸ë¦¬ë‹ˆí‹°ì—ê²Œ | To Luwein Trinity</title>
<style>
:root{
  --header-color:#af2465;
  --menu-bg-color:#6c5b7b;
  --menu-text-color:#ffffff;
  --menu-hover-text:#2a9d8f;
  --page-padding:24px;
}
*{box-sizing:border-box}
body{margin:0;font-family:system-ui,-apple-system,"Noto Sans KR","Apple SD Gothic Neo",sans-serif}
header{background:#fff;color:#af2465;font-size:40px;font-weight:800;text-align:center;padding:18px 12px;border-bottom:1px solid #ddd}
main{padding:var(--page-padding)}
.box{background:#fff;border:1px solid #e9e9ee;border-radius:14px;padding:16px;max-width:900px;margin:auto}
input,textarea,button{font:inherit}
input,textarea{width:100%;padding:10px;border:1px solid #e9e9ee;border-radius:10px}
button{background:#2a9d8f;color:#fff;border:none;border-radius:10px;padding:10px 14px;cursor:pointer}
.list{display:grid;gap:10px;margin-top:16px}
.item{background:#fff;border:1px solid #e9e9ee;border-radius:12px;padding:12px}
.meta{font-size:.85rem;color:#666;margin-bottom:6px;text-align:left}
</style>
</head>

<body>
<header>ë£¨ì›¨ì¸ íŠ¸ë¦¬ë‹ˆí‹°</header>
<main>
  <h1 id="hello">íŠ¸ë¦¬ë‹ˆí‹°ì—ê²Œ</h1>

  <div class="box">
    <label>ì œëª©</label>
    <input id="title" placeholder="ì˜ˆ: ì˜¤ëŠ˜ì˜ ê°ì‚¬" />
    <label style="margin-top:8px;display:block">ë‚´ìš©</label>
    <textarea id="body" rows="5" placeholder="í¸ì§€ë¥¼ ì ì–´ë³´ì„¸ìš”."></textarea>

    <div style="margin-top:10px;display:flex;gap:8px;align-items:center">
      <button id="save">ë³´ë‚´ê¸°</button>
      <button id="reload">ìƒˆë¡œê³ ì¹¨</button>
    </div>
  </div>

  <section>
    <h2 style="margin-top:24px;">ë³´ê´€í•¨</h2>
    <div class="list" id="list"></div>
  </section>
</main>

<script type="module">
  import { supabase } from "/assets/js/supabase.js";

  const user = JSON.parse(localStorage.getItem("ed_user") || '{"name":"ìµëª…"}');
  document.getElementById("hello").textContent = `${user.name}ì˜ í¸ì§€í•¨`;

  const titleInput = document.getElementById("title");
  const bodyInput = document.getElementById("body");
  const listBox = document.getElementById("list");

  // ğŸ”¹ í¸ì§€ ë¶ˆëŸ¬ì˜¤ê¸°
  async function loadLetters() {
    const { data, error } = await supabase
      .from("trinity_letters")
      .select("*")
      .eq("user_name", user.name)
      .order("created_at", { ascending: false });

    if (error) {
      console.error(error);
      listBox.innerHTML = `<p style="color:red">âš ï¸ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨</p>`;
      return;
    }

    if (!data.length) {
      listBox.innerHTML = `<p style="color:#666">ì•„ì§ í¸ì§€ê°€ ì—†ìŠµë‹ˆë‹¤.</p>`;
      return;
    }

    listBox.innerHTML = "";
    data.forEach((it) => {
      const div = document.createElement("div");
      div.className = "item";
      div.innerHTML = `
        <div class="meta">${new Date(it.created_at).toLocaleString()}</div>
        <strong>${it.title || "(ì œëª© ì—†ìŒ)"}</strong>
        <div>${(it.body || "").replace(/\n/g, "<br>")}</div>
      `;
      listBox.appendChild(div);
    });
  }

  // ğŸ”¹ í¸ì§€ ì €ì¥
  async function saveLetter() {
    const title = titleInput.value.trim();
    const body = bodyInput.value.trim();
    if (!title && !body) {
      alert("ì œëª© ë˜ëŠ” ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
      return;
    }

    const { error } = await supabase.from("trinity_letters").insert([
      {
        user_name: user.name,
        title,
        body,
      },
    ]);

    if (error) {
      alert("ì €ì¥ ì‹¤íŒ¨: " + error.message);
      return;
    }

    titleInput.value = "";
    bodyInput.value = "";
    await loadLetters();
  }

  document.getElementById("save").addEventListener("click", saveLetter);
  document.getElementById("reload").addEventListener("click", loadLetters);

  loadLetters();
</script>
</body>
</html>
