<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0" />
<title>🎨 낙서장 | Luwein Doodle Board</title>
<style>
body{
  margin:0;font-family:'Noto Sans KR',sans-serif;background:#fdfdfd;color:#333;text-align:center;
}
header{
  background:#6cbba4;color:#fff;padding:16px;font-size:1.6rem;font-weight:700;
}
canvas{
  background:#fff;border:1px solid #ccc;border-radius:10px;cursor:crosshair;
}
.controls{
  margin-top:10px;display:flex;justify-content:center;gap:10px;flex-wrap:wrap;
}
button,input[type=color]{
  font:inherit;padding:8px 12px;border:none;border-radius:8px;cursor:pointer;
}
button.save{background:#2a9d8f;color:#fff;}
button.clear{background:#af2465;color:#fff;}
.gallery{
  margin-top:30px;display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:12px;max-width:900px;margin-inline:auto;
}
.item img{
  width:100%;border-radius:10px;box-shadow:0 2px 8px rgba(0,0,0,0.1);
}
.caption{font-size:.9rem;color:#666;margin-top:4px}
</style>
</head>

<body>
<header>🎨 낙서장</header>

<main style="padding:20px">
  <canvas id="board" width="600" height="400"></canvas>

  <div class="controls">
    <input type="color" id="color" value="#2a9d8f" />
    <button id="clear" class="clear">지우기</button>
    <button id="save" class="save">저장하기</button>
  </div>

  <section class="gallery" id="gallery"></section>
</main>

<script type="module">
import { supabase } from "/assets/js/supabase.js";

const canvas = document.getElementById("board");
const ctx = canvas.getContext("2d");
let drawing = false;
let color = document.getElementById("color").value;
const user = JSON.parse(localStorage.getItem("ed_user") || '{"name":"익명"}');

// 🖌️ 그리기 기능
canvas.addEventListener("mousedown", () => (drawing = true));
canvas.addEventListener("mouseup", () => (drawing = false));
canvas.addEventListener("mouseout", () => (drawing = false));
canvas.addEventListener("mousemove", draw);
document.getElementById("color").addEventListener("input", (e) => (color = e.target.value));

function draw(e) {
  if (!drawing) return;
  const rect = canvas.getBoundingClientRect();
  const x = e.clientX - rect.left;
  const y = e.clientY - rect.top;
  ctx.fillStyle = color;
  ctx.beginPath();
  ctx.arc(x, y, 3, 0, Math.PI * 2);
  ctx.fill();
}

// 🧽 지우기
document.getElementById("clear").addEventListener("click", () => {
  ctx.clearRect(0, 0, canvas.width, canvas.height);
});

// 💾 저장 (Supabase Storage + Table)
document.getElementById("save").addEventListener("click", async () => {
  const dataURL = canvas.toDataURL("image/png");
  const fileName = `${user.name}_${Date.now()}.png`;

  // Blob 변환
  const blob = await (await fetch(dataURL)).blob();

  // 1. Storage 업로드
  const { data: uploadData, error: uploadError } = await supabase.storage
    .from("ruwein-gallery")
    .upload(`doodles/${fileName}`, blob, { upsert: true, contentType: "image/png" });

  if (uploadError) {
    alert("업로드 실패: " + uploadError.message);
    return;
  }

  // 2. Public URL
  const { data: publicUrlData } = supabase.storage
    .from("ruwein-gallery")
    .getPublicUrl(`doodles/${fileName}`);

  const url = publicUrlData.publicUrl;

  // 3. DB에 기록 추가
  const { error: dbError } = await supabase.from("gallery_personal").insert([
    { user_name: user.name, title: "낙서", file_url: url },
  ]);

  if (dbError) {
    alert("DB 저장 실패: " + dbError.message);
    return;
  }

  alert("✅ 저장 완료!");
  loadGallery();
});

// 📸 개인 낙서 불러오기
async function loadGallery() {
  const { data, error } = await supabase
    .from("gallery_personal")
    .select("*")
    .eq("user_name", user.name)
    .order("created_at", { ascending: false });

  const box = document.getElementById("gallery");
  if (error || !data.length) {
    box.innerHTML = `<p style="grid-column:1/-1;color:#666">아직 저장된 낙서가 없습니다.</p>`;
    return;
  }

  box.innerHTML = "";
  data.forEach((it) => {
    const div = document.createElement("div");
    div.className = "item";
    div.innerHTML = `<img src="${it.file_url}" alt="doodle"><div class="caption">${it.title}</div>`;
    box.appendChild(div);
  });
}

loadGallery();
</script>
</body>
</html>
