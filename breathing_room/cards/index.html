<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>ë‚˜ì˜ ê°ì •ì¹´ë“œ | ìˆ¨ í‹”ì›€ë°©</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
body {
  font-family:'Noto Sans KR',sans-serif;
  background:#f8fbfa;
  margin:0;padding:2rem;
  color:#333;
}
h1{text-align:center;color:#af2465;}
form{
  max-width:600px;margin:0 auto 2rem;background:#fff;
  padding:20px;border-radius:10px;box-shadow:0 2px 8px rgba(0,0,0,.08);
}
form input,form textarea,form button{
  width:100%;padding:10px;margin:6px 0;font-size:15px;border:1px solid #ccc;border-radius:8px;
}
form button{background:#2a9d8f;color:#fff;cursor:pointer;}
form button:hover{background:#237e74;}
#cardList{display:flex;flex-wrap:wrap;gap:1rem;justify-content:center;}
.card{
  width:300px;background:#fff;border-radius:10px;box-shadow:0 3px 6px rgba(0,0,0,.1);
  overflow:hidden;padding:15px;position:relative;
}
.card img{width:100%;height:180px;object-fit:cover;border-radius:8px;}
.card .emotion{color:#af2465;font-weight:700;font-size:1.2rem;}
.card .date{font-size:.8rem;color:#888;margin-bottom:8px;}
.card .ai{background:#f3f3f3;padding:6px;border-radius:6px;font-size:.85rem;color:#555;}
.card .actions{margin-top:10px;display:flex;justify-content:space-between;}
.card button{
  border:none;background:#ddd;padding:6px 10px;border-radius:6px;cursor:pointer;
}
.card button:hover{background:#bbb;}
</style>
</head>
<body>
<h1>ğŸª¶ ë‚˜ì˜ ê°ì •ì¹´ë“œ</h1>

<form id="emotionForm">
  <input list="emotionList" id="emotion" placeholder="ê°ì •ì„ ì…ë ¥ ë˜ëŠ” ì„ íƒ" required>
  <datalist id="emotionList">
    <option>ê¸°ì¨</option><option>ìŠ¬í””</option><option>ë¶„ë…¸</option>
    <option>ë¶ˆì•ˆ</option><option>í‰ì˜¨</option><option>ì‚¬ë‘</option>
  </datalist>
  <textarea id="content" rows="3" placeholder="ì˜¤ëŠ˜ì˜ ê°ì •ì„ ê°„ë‹¨íˆ ë‚¨ê²¨ì£¼ì„¸ìš”" required></textarea>
  <input type="file" id="imageInput" accept="image/*">
  <label><input type="checkbox" id="shareCheck"> ê³µìœ í•˜ê¸° (ê³µê° ì•¨ë²”ì— ë…¸ì¶œ)</label><br>
  <button type="submit">ì €ì¥í•˜ê¸°</button>
</form>

<div id="cardList"></div>

<script>
const SUPABASE_URL = "https://omchtafaqgkdwcrwscrp.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9tY2h0YWZhcWdrZHdjcndzY3JwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg4ODIyNjMsImV4cCI6MjA3NDQ1ODI2M30.vGV6Gfgi1V8agiwL03ho2R7BAwv4CrTp6-RGH0S3-4g";
const supabase = window.supabase.createClient(SUPABASE_URL,SUPABASE_KEY);
const list = document.getElementById("cardList");

// ê°ì • ë¶„ì„ (ê°„ë‹¨ ì˜ˆì‹œ)
function aiFeedback(emotion){
  const map={
    "ê¸°ì¨":"ë‹¹ì‹ ì˜ ë°ì€ ì—ë„ˆì§€ê°€ ì£¼ë³€ì—ë„ ì „í•´ì§€ê³  ìˆì–´ìš” ğŸŒ",
    "ìŠ¬í””":"ê´œì°®ì•„ìš”. ìŠ¬í””ë„ ë‹¹ì‹ ì˜ ì¼ë¶€ì˜ˆìš” ğŸŒ§",
    "ë¶„ë…¸":"ê¹Šê²Œ ìˆ¨ ì‰¬ì„¸ìš”. ê°ì •ì€ ë‹¹ì‹ ì„ ì§€ë°°í•˜ì§€ ì•Šì•„ìš” ğŸ”¥",
    "ë¶ˆì•ˆ":"ëª¨ë“  ê²Œ ë³€í•˜ë“¯, ì´ ìˆœê°„ë„ ì§€ë‚˜ê°€ìš” ğŸŒ™",
    "í‰ì˜¨":"ì´ í‰ì˜¨í•¨ì´ ì˜¤ë˜ ì§€ì†ë˜ê¸¸ ğŸŒ¿",
    "ì‚¬ë‘":"ì‚¬ë‘ì€ ìš¸ë¦¼ì˜ ì‹œì‘ì´ì—ìš” ğŸ’—"
  };
  return map[emotion]||"ë‹¹ì‹ ì˜ ê°ì •ì„ ì˜ ëŠë¼ê³  ìˆë„¤ìš”.";
}

// ì—…ë¡œë“œ ì²˜ë¦¬
document.getElementById("emotionForm").addEventListener("submit",async(e)=>{
  e.preventDefault();
  const emotion=document.getElementById("emotion").value.trim();
  const content=document.getElementById("content").value.trim();
  const file=document.getElementById("imageInput").files[0];
  const is_shared=document.getElementById("shareCheck").checked;
  if(!emotion||!content)return alert("ëª¨ë“  í•„ë“œë¥¼ ì…ë ¥í•˜ì„¸ìš”.");

  let image_url=null;
  if(file){
    const filename=`${Date.now()}_${file.name}`;
    await supabase.storage.from("emotion_images").upload(filename,file);
    const { data } = supabase.storage.from("emotion_images").getPublicUrl(filename);
    image_url=data.publicUrl;
  }

  const ai_feedback=aiFeedback(emotion);
  const { error } = await supabase.from("emotion_cards").insert([{emotion,content,image_url,ai_feedback,is_shared}]);
  if(error)return alert("ì €ì¥ ì‹¤íŒ¨: "+error.message);
  loadCards();
  e.target.reset();
});

// ì¹´ë“œ ë¡œë“œ
async function loadCards(){
  const { data,error }=await supabase.from("emotion_cards").select("*").order("id",{ascending:false});
  if(error)return console.error(error);
  list.innerHTML=data.map(c=>`
    <div class="card">
      ${c.image_url?`<img src="${c.image_url}">`:""}
      <div class="emotion">${c.emotion}</div>
      <div class="date">${new Date(c.created_at).toLocaleString()}</div>
      <div>${c.content}</div>
      <div class="ai">ğŸ¤– ${c.ai_feedback}</div>
      <div class="actions">
        ${c.is_shared?"<span style='color:#2a9d8f;'>ğŸŒ ê³µìœ ë¨</span>":""}
        <button onclick="deleteCard(${c.id})">ì‚­ì œ</button>
      </div>
    </div>`).join("");
}
loadCards();

// ì‚­ì œ
async function deleteCard(id){
  if(!confirm("ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?"))return;
  await supabase.from("emotion_cards").delete().eq("id",id);
  loadCards();
}
</script>
</body>
</html>
