<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>ë£¨ì›¨ì¸ ìœµí•©ì‹¤ | LUWAIN Trinity</title>
<link rel="icon" href="/assets/icons/pwa-192.png"/>
<style>
body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Apple SD Gothic Neo,Malgun Gothic,sans-serif;margin:0;padding:24px;line-height:1.5;background:#0b0e12;color:#e8ecf1}
.wrap{max-width:1000px;margin:0 auto}
.card{background:#121621;border:1px solid #1f2533;border-radius:16px;padding:16px;margin-bottom:16px}
.row{display:flex;gap:12px;flex-wrap:wrap}
.row>*{flex:1}
input,textarea,button{width:100%;padding:12px;border-radius:12px;border:1px solid #2a3244;background:#0e1320;color:#dbe4f4}
button{cursor:pointer}
.pill{display:inline-block;padding:4px 10px;border:1px solid #2a3244;border-radius:999px;margin-right:6px;font-size:12px}
.msg{white-space:pre-wrap;background:#0e1320;border:1px solid #2a3244;border-radius:12px;padding:12px;margin-bottom:6px}
.muted{color:#9fb0c7}
.tiny{font-size:12px}
</style>
<script type="module">
import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

const SUPABASE_URL = "https://YOUR-PROJECT.supabase.co"; // ì›í•˜ë©´ êµì²´
const SUPABASE_KEY = "YOUR-PUBLIC-ANON-KEY"; // ì›í•˜ë©´ êµì²´
const sb = SUPABASE_URL.startsWith("https") ? createClient(SUPABASE_URL, SUPABASE_KEY) : null;

const uid=()=>crypto.randomUUID?.()||(Date.now()+"_"+Math.random().toString(16).slice(2));
const now=()=>new Date().toISOString();
const NS="luwain_fusion_v1";
const read=()=>JSON.parse(localStorage.getItem(NS)||"{}");
const write=(x)=>localStorage.setItem(NS,JSON.stringify(x));
const all=()=>Object.values(read());
const get=(id)=>read()[id];
const create=({title,topic,tags})=>{
 const db=read();const id=uid();
 db[id]={id,title,topic,tags,created_at:now(),updated_at:now(),messages:[]};write(db);return db[id];
};
const push=(id,msg)=>{
 const db=read();db[id].messages.push(msg);db[id].updated_at=msg.ts;write(db);
};
const summar=(id)=>{
 const t=get(id);if(!t)return"";const by={user:[],persona:[],note:[]};
 for(const m of t.messages)(by[m.role]??=[]).push(m.content);
 return `â–  ${t.title}\n${t.topic?`í† í”½: ${t.topic}\n`:""}${
 t.tags?.length?`íƒœê·¸: ${t.tags.join(", ")}\n`:""}â€” ì‚¬ìš©ì â€”\n${by.user.slice(-2).join("\n")}\nâ€” í¼ìŠ¤ë‚˜ â€”\n${by.persona.slice(-3).join("\n")}\nâ€” ë…¸íŠ¸ â€”\n${by.note.slice(-2).join("\n")}`;
};
const personas=[
 (topic,p)=>`ë ˆì¹´: ${topic} â†’ êµ¬ì¡° ê²€í†  ë° ë²„ì „ ì¶©ëŒ í™•ì¸.`,
 (topic,p)=>`ìŠ¬ê¸°: ${topic} â†’ ë©”íƒ€ë°ì´í„°Â·ìƒ‰ì¸ ì •í•©ì„± ì ê²€.`,
 (topic,p)=>`ë£¨ë²¤ë‚˜: ${topic} â†’ UI/UX í†µì¼ ë° í°íŠ¸ ìŠ¤ì¼€ì¼ ë¶„ì„.`,
 (topic,p)=>`ìŠ¤ë§ˆíŠ¸í•œ: ${topic} â†’ ìºì‹œÂ·ë°°í¬ ìë™í™” íë¦„ ì œì•ˆ.`
];

const sync=async(id)=>{
 if(!sb)return"ë¡œì»¬ ëª¨ë“œ";
 const t=get(id);if(!t)return"ì‹¤íŒ¨";
 await sb.from("fusion_threads").upsert({id:t.id,title:t.title,topic:t.topic,tags:t.tags,created_at:t.created_at,updated_at:t.updated_at});
 const rows=t.messages.map(m=>({...m,thread_id:id}));
 if(rows.length)await sb.from("fusion_messages").upsert(rows);
 return"ì„œë²„ ë™ê¸°í™” ì™„ë£Œ";
};

// UI ì—°ê²°
const $=s=>document.querySelector(s);
const renderThreads=()=>{
 const ts=all().sort((a,b)=>b.updated_at.localeCompare(a.updated_at));
 $("#threads").innerHTML=ts.map(t=>`
 <div class='card'><b>${t.title}</b>
 <div class='muted tiny'>${t.topic||""}</div>
 <div>${(t.tags||[]).map(x=>`<span class='pill'>${x}</span>`).join(" ")}</div>
 <div class='tiny muted'>${t.updated_at}</div>
 <button data-id='${t.id}'>ì—´ê¸°</button></div>`).join("")||"<div class='muted tiny'>ìŠ¤ë ˆë“œ ì—†ìŒ</div>";
 $("#threads").querySelectorAll("button").forEach(b=>b.onclick=()=>openThread(b.dataset.id));
};
const openThread=(id)=>{
 window.current=id;
 const t=get(id);
 $("#meta").textContent=`#${t.id} â€¢ ${t.title} â€¢ ${t.topic}`;
 $("#msgs").innerHTML=t.messages.map(m=>`<div class='msg'><b>${m.role}</b> ${m.content}</div>`).join("")||"<div class='muted tiny'>ë©”ì‹œì§€ ì—†ìŒ</div>";
};

$("#create").onclick=()=>{
 const t=create({title:$("#title").value.trim()||"Untitled",topic:$("#topic").value.trim(),tags:$("#tags").value.split(",").map(s=>s.trim()).filter(Boolean)});
 push(t.id,{id:uid(),author:"ê³µëª…",role:"user",content:$("#userMsg").value.trim(),ts:now()});
 renderThreads();openThread(t.id);
};

$("#ask").onclick=()=>{
 const t=get(window.current);if(!t)return;
 const u=t.messages.filter(m=>m.role==="user").slice(-1)[0]?.content||"";
 for(const f of personas){push(t.id,{id:uid(),author:"persona",role:"persona",content:f(t.topic,u),ts:now()});}
 openThread(window.current);
};

$("#sum").onclick=()=>{
 const s=summar(window.current);push(window.current,{id:uid(),author:"system",role:"note",content:s,ts:now()});openThread(window.current);
};

$("#sync").onclick=async()=>{
 const r=await sync(window.current);
 push(window.current,{id:uid(),author:"system",role:"note",content:r,ts:now()});openThread(window.current);
};

renderThreads();
</script>
</head>
<body>
<div class="wrap">
<h1>ğŸ¤ ë£¨ì›¨ì¸ ìœµí•©ì‹¤</h1>
<div class="card">
<div class="row">
<input id="title" placeholder="ì œëª©"/>
<input id="topic" placeholder="í† í”½"/>
</div>
<input id="tags" placeholder="íƒœê·¸(ì‰¼í‘œ êµ¬ë¶„)"/>
<textarea id="userMsg" rows="4" placeholder="ìš”êµ¬ì‚¬í•­ ì…ë ¥"></textarea>
<div class="row">
<button id="create">ìœµí•©ì‹¤ ë§Œë“¤ê¸°</button>
<button id="ask">í¼ìŠ¤ë‚˜ í˜¸ì¶œ</button>
<button id="sum">í†µí•© ìš”ì•½</button>
<button id="sync">ë™ê¸°í™”</button>
</div>
</div>
<div class="card"><h3>ìŠ¤ë ˆë“œ ëª©ë¡</h3><div id="threads"></div></div>
<div class="card"><h3>ë©”ì‹œì§€</h3><div id="meta" class="tiny muted"></div><div id="msgs"></div></div>
</div>
</body>
</html>
