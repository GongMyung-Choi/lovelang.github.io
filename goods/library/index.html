<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ìŠ¬ê¸°ë„ì„œê´€ Â· ìë™ ì¸ë±ìŠ¤</title>
<style>
  :root{--bg:#ffffff;--ink:#111827;--muted:#6b7280;--line:#e5e7eb;--tag:#eef2ff;--brand:#2563eb}
  *{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--ink);font:15px/1.6 system-ui,AppleSDGothicNeo,Segoe UI,Roboto,Apple Color Emoji}
  header{position:sticky;top:0;background:#fffccf80;backdrop-filter:saturate(120%) blur(6px);border-bottom:1px solid var(--line);padding:12px 16px;z-index:10}
  header h1{margin:0;font-size:18px}
  .controls{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
  .pill{padding:6px 10px;border:1px solid var(--line);border-radius:999px;background:#fff;cursor:pointer}
  .pill.active{border-color:var(--brand);color:var(--brand);background:#f8fbff}
  main{padding:16px;max-width:1200px;margin:0 auto}
  .grid{display:grid;gap:14px;grid-template-columns:repeat(auto-fill,minmax(280px,1fr))}
  .card{border:1px solid var(--line);border-radius:12px;padding:14px;background:#fff;display:flex;flex-direction:column;gap:8px}
  .card h3{margin:0 0 2px 0;font-size:16px}
  .meta{font-size:12px;color:var(--muted)}
  .tags{display:flex;gap:6px;flex-wrap:wrap}
  .tag{font-size:11px;background:var(--tag);padding:2px 8px;border-radius:999px}
  .path{font-size:11px;color:#6b7280}
  .empty{padding:40px;border:1px dashed var(--line);border-radius:12px;text-align:center;color:var(--muted)}
  footer{color:var(--muted);text-align:center;padding:28px 12px}
  .sr-only{position:absolute;left:-9999px}
</style>
</head>
<body>
<header>
  <h1>ìŠ¬ê¸°ë„ì„œê´€ ìë™ ì¸ë±ìŠ¤</h1>
  <div class="controls" id="filters"></div>
</header>

<main>
  <div id="results" class="grid"></div>
  <div id="empty" class="empty" style="display:none">í‘œì‹œí•  í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤.</div>
</main>

<footer>ìë™ ë¶„ë¥˜ ê¸°ì¤€: <b>KDC</b> â†’ <b>í‚¤ì›Œë“œ</b> â†’ <b>í´ë”ëª…</b> (ìš°ì„ ìˆœìœ„)</footer>

<script>
/* ========= ì‚¬ìš©ì ì„¤ì •: ê²½ë¡œ Manifest =========
   - GitHub PagesëŠ” í´ë” ëª©ë¡ì„ ì§ì ‘ ì½ì„ ìˆ˜ ì—†ì–´ì„œ
     paths.json(ì•„ë˜)ë¡œ í´ë” ê²½ë¡œë§Œ ì•Œë ¤ì£¼ë©´ ë‚´ìš©ì€ ìë™ìœ¼ë¡œ íŒŒì‹±í•©ë‹ˆë‹¤.
   - ìƒˆ í´ë” ìƒê¸°ë©´ paths.jsonì— í•œ ì¤„ë§Œ ì¶”ê°€í•˜ë©´ ë©ë‹ˆë‹¤. (ì™„ì „ ìë™ì€ GH Actionsë¡œ ê°€ëŠ¥)
*/
const MANIFEST_URL = './paths.json';

/* ========= ë¶„ë¥˜ ë§¤í•‘ ========= */
const CATEGORY_MAP = [
  {name:'ì² í•™',  test:k => k.kdc?.startsWith('1') || /ì² í•™|ì–¸ì–´ì² í•™|ì¡´ì¬|ì¸ì‹/.test(k.words)},
  {name:'ì˜ì„±Â·ì¢…êµ', test:k => k.kdc?.startsWith('2') || /ì˜ì„±|ì‹ ì•™|ì„±ë‹¹|íŠ¸ë¦¬ë‹ˆí‹°/.test(k.words)},
  {name:'ì‚¬íšŒÂ·ì¸ë¬¸', test:k => k.kdc?.startsWith('3') || /ì‚¬íšŒ|ìœ¤ë¦¬|ì •ì¹˜|ë¬¸í™”|ë¯¼ì¤‘|ì—°ëŒ€/.test(k.words)},
  {name:'ìì—°Â·ê³¼í•™', test:k => /^5|^6/.test(k.kdc||'') || /ê³¼í•™|ë¬¼ë¦¬|íŒŒë™|ê¸°ìˆ |AI|ì•Œê³ ë¦¬ì¦˜|ëª¨ë“ˆ/.test(k.words)},
  {name:'ì˜ˆìˆ Â·ë¬¸í•™', test:k => k.kdc?.startsWith('8') || /ì†Œì„¤|ì‹œì§‘|ì‹œë‚˜ë¦¬ì˜¤|ì—ì„¸ì´|ë¬¸í•™|ë“œë¼ë§ˆ|ì‹œë¦¬ì¦ˆ/.test(k.words)},
  {name:'ê¸°íƒ€', test:_ => true}
];

/* ========= ìœ í‹¸ ========= */
const $ = sel => document.querySelector(sel);
const el = (tag, attrs={}, ...kids) => {
  const n=document.createElement(tag);
  Object.entries(attrs).forEach(([k,v])=>{ if(k==='class') n.className=v; else n.setAttribute(k,v); });
  kids.forEach(k=> n.append(k));
  return n;
};
function trim(s){return (s||'').toString().replace(/^\s+|\s+$/g,'');}

/* ========= summary.txt / metadata.json íŒŒì„œ ========= */
function parseSummaryTxt(txt){
  const lines = txt.split(/\r?\n/).map(l=>l.trim()).filter(Boolean);
  const get = label => {
    const r = new RegExp('^\\s*'+label+'\\s*:\\s*(.+)$','i');
    const f = lines.find(l=>r.test(l));
    return f ? trim(f.replace(r,'$1')) : '';
  };
  const body = lines.join(' ');
  return {
    title: get('ì œëª©') || '',
    author: get('ì €ì') || '',
    kdc: (get('KDC') || get('ë¶„ë¥˜') || '').replace(/[^\d.].*$/,''),
    category: get('ë¶„ë¥˜') || '',
    tags: (get('íƒœê·¸')||'').split(/[,#\s]+/).filter(Boolean),
    abstract: get('ìš”ì•½') || (body.length>0 ? body.slice(0,200)+'â€¦' : '')
  };
}
function normalizeMeta(meta){
  return {
    title: meta.title || meta.ì œëª© || '',
    author: meta.author || meta.ì €ì || '',
    kdc: (meta.kdc || meta.KDC || meta.category || '').toString().replace(/[^\d.].*$/,''),
    category: meta.category_name || meta.ë¶„ë¥˜ || '',
    tags: meta.tags || meta.íƒœê·¸ || [],
    abstract: meta.abstract || meta.ìš”ì•½ || ''
  };
}

/* ========= ìë™ ë¶„ë¥˜ê¸° ========= */
function decideCategory(info, path){
  const words = [
    info.category, info.abstract, info.title, info.tags?.join(' '), path
  ].join(' ').toLowerCase();
  const k = {kdc:(info.kdc||'').toString(), words};
  const found = CATEGORY_MAP.find(c=>c.test(k));
  return found?.name || 'ê¸°íƒ€';
}

/* ========= ì¹´ë“œ ë Œë” ========= */
function card(item){
  const box = el('div',{class:'card'});
  box.append(
    el('h3',{}, item.title || '(ì œëª© ì—†ìŒ)'),
    el('div',{class:'meta'}, `ì €ì: ${item.author||'â€”'} Â· ë¶„ë¥˜/KDC: ${item.kdc||'â€”'} Â· ì½”ë„ˆ: ${item.categoryGroup}`),
    el('div',{}, item.abstract||'ìš”ì•½ ì—†ìŒ'),
    el('div',{class:'tags'},
      ...(item.tags||[]).slice(0,6).map(t=>el('span',{class:'tag'}, '#'+t))
    ),
    el('div',{class:'path'}, `ğŸ“‚ ${item.path}`),
  );
  return box;
}

/* ========= í•„í„° UI ========= */
function buildFilters(groups, onSelect){
  const wrap = $('#filters'); wrap.innerHTML='';
  const allBtn = el('button',{class:'pill active','data-cat':'ALL'},'ì „ì²´');
  wrap.append(allBtn);
  Object.keys(groups).forEach(cat=>{
    wrap.append(el('button',{class:'pill','data-cat':cat},cat));
  });
  wrap.addEventListener('click',e=>{
    if(!e.target.matches('.pill')) return;
    wrap.querySelectorAll('.pill').forEach(p=>p.classList.remove('active'));
    e.target.classList.add('active');
    onSelect(e.target.getAttribute('data-cat'));
  });
}

/* ========= ë¡œë”© ë£¨í‹´ ========= */
async function tryFetch(url){
  try{
    const r = await fetch(url);
    if(!r.ok) throw new Error(r.status);
    return await r.text();
  }catch{ return null; }
}
async function loadItem(path){
  // 1) summary.txt
  const sTxt = await tryFetch(`${path}/summary.txt`);
  let info = sTxt ? parseSummaryTxt(sTxt) : null;

  // 2) metadata.json
  const mTxt = await tryFetch(`${path}/metadata.json`);
  if(mTxt){
    try{
      const meta = JSON.parse(mTxt);
      const norm = normalizeMeta(meta);
      info = Object.assign({},
        {title:'',author:'',kdc:'',category:'',tags:[],abstract:''},
        norm, info||{}
      );
    }catch{}
  }

  // 3) EPUB íŒíŠ¸ë§Œ ìˆëŠ” í´ë”(OEBPS/mimetype) â†’ ì„ì‹œ ì¹´ë“œ
  if(!info){
    const mim = await tryFetch(`${path}/mimetype`);
    if(mim!==null){
      info = {title:path.split('/').pop(), author:'â€”', kdc:'', category:'ì „ìì±…', tags:['epub'], abstract:'(EPUB êµ¬ì¡° ê°ì§€ë¨)'};
    }
  }

  if(!info) return null;
  info.categoryGroup = decideCategory(info, path);
  info.path = path;
  return info;
}

async function main(){
  const res = await fetch(MANIFEST_URL).then(r=>r.json());
  const paths = res.paths || [];
  const items = (await Promise.all(paths.map(loadItem))).filter(Boolean);

  // ê·¸ë£¹í•‘
  const byCat = {};
  for(const it of items){
    if(!byCat[it.categoryGroup]) byCat[it.categoryGroup]=[];
    byCat[it.categoryGroup].push(it);
  }

  // í•„í„° ìƒì„±
  buildFilters(byCat, cat=>{
    render(cat==='ALL' ? items : byCat[cat]||[]);
  });

  // ì´ˆê¸° ë Œë”
  render(items);
}

function render(list){
  const box = $('#results'); box.innerHTML='';
  if(!list.length){ $('#empty').style.display='block'; return; }
  $('#empty').style.display='none';
  // ìµœì‹ ìˆœ ì •ë ¬: ê²½ë¡œëª…ì— ë‚ ì§œê°€ ìˆìœ¼ë©´ ê·¸ê±¸ë¡œ, ì—†ìœ¼ë©´ ì•ŒíŒŒ
  list.sort((a,b)=> (b.path>a.path?1:-1));
  list.forEach(it=> box.append(card(it)));
}

main();
</script>
</body>
</html>
