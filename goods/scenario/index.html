<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>루웨인 시나리오 아카이브</title>
<link rel="stylesheet" href="../../haneul/common.css" />
<link rel="stylesheet" href="./scenario.css" />
<script>
let scenarios = [];

async function loadFolders() {
  try {
    const res = await fetch("./paths.json", { cache: "no-store" });
    const data = await res.json();
    scenarios = data.scenarios || [];
  } catch (e) {
    console.error("시나리오 목록 로드 실패:", e);
    scenarios = [];
  }
  renderList("latest");
}

async function loadSummary(targetId, path) {
  const box = document.getElementById(targetId);
  if (box.dataset.loading === "true") return;
  if (box.style.display === "block") { box.style.display = "none"; return; }

  box.innerHTML = '<div class="loader"></div>';
  box.style.display = "block";
  box.dataset.loading = "true";

  try {
    const res = await fetch(`${path}/summary.txt`);
    const text = await res.text();
    box.innerHTML = `<div class="summary-text">${text}</div>`;
    autoTrim(box);
  } catch {
    box.innerHTML = "<div class='summary-text'>요약 파일을 불러올 수 없습니다.</div>";
  } finally {
    box.dataset.loading = "false";
  }
}

function autoTrim(box) {
  const txt = box.querySelector(".summary-text");
  if (!txt) return;
  const limit = 300;
  const full = txt.textContent.trim();
  if (full.length <= limit) return;

  const short = full.slice(0, limit) + " ...";
  txt.textContent = short;

  const btn = document.createElement("button");
  btn.textContent = "더보기";
  btn.className = "more-btn";
  btn.onclick = () => {
    if (btn.textContent === "더보기") {
      txt.textContent = full; btn.textContent = "접기";
    } else {
      txt.textContent = short; btn.textContent = "더보기";
    }
  };
  box.appendChild(btn);
}

function renderList(order = "latest") {
  const grid = document.querySelector(".grid");
  grid.innerHTML = "";
  let sorted = [...scenarios];
  if (order === "alpha") sorted.sort((a, b) => a.title.localeCompare(b.title, "ko"));
  if (order === "latest") sorted = sorted.reverse();

  sorted.forEach(s => {
    const card = document.createElement("div");
    card.className = "card";
    card.innerHTML = `
      <h3>${s.title}</h3>
      <img src="./${s.id}/cover.png" alt="${s.title} 표지" class="cover"
           onclick="loadSummary('sum-${s.id}','./${s.id}')">
      <div id="sum-${s.id}" class="summary" data-loading="false"></div>
      <a class="download" href="./${s.id}/${s.id}.pdf" download>시나리오 다운로드</a>
    `;
    grid.appendChild(card);
  });
}

window.addEventListener("DOMContentLoaded", () => {
  document.getElementById("order-select").addEventListener("change", e => renderList(e.target.value));
  loadFolders();
});
</script>
</head>
<body>
<header>
  <div class="header-inner">
    <h1><a href="../../index.html">루웨인 트리니티</a></h1>
    <nav>
      <ul>
        <li><a href="../../about.html">소개</a></li>
        <li><a href="../../library/index.html">라이브러리</a></li>
        <li><a href="../../goods/index.html">굿즈</a></li>
        <li><a href="../../contact.html">문의</a></li>
      </ul>
    </nav>
  </div>
</header>

<main>
  <h1>루웨인 시나리오 아카이브</h1>
  <p>표지를 클릭하면 요약을 보고, PDF로 시나리오를 다운로드할 수 있습니다.</p>

  <div class="toolbar">
    <label for="order-select">정렬:</label>
    <select id="order-select">
      <option value="latest">최신순</option>
      <option value="alpha">가나다순</option>
    </select>
  </div>

  <div class="grid"></div>
</main>

<footer>
  <div class="footer-inner">
    <p>© 2025 루웨인 트리니티. All rights reserved.</p>
  </div>
</footer>
</body>
</html>
